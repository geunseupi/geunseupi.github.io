<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê·¼ìŠ¤í”¼</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js and necessary plugins for Time Series and Zoom/Pan -->
    
    <script src="https://cdn.jsdelivr.net/npm/hammerjs/hammer.min.js"></script> <!-- ìš”ì²­í•˜ì‹  Hammer.js í¬í•¨ -->
    <!-- Chart.js v4+ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- chartjs-plugin-zoom v2.2.0 (ìµœì‹  ë²„ì „ìœ¼ë¡œ ì—…ë°ì´íŠ¸) -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.2.0"></script>

    <style>
        /* í°íŠ¸ ì„¤ì • ë° ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; }
        #chartContainer { max-width: 1200px; margin: 0 auto; }
        /* ì°¨íŠ¸ ìº”ë²„ìŠ¤ ìŠ¤íƒ€ì¼ */
        .chart-canvas { 
            background-color: white; 
            border-radius: 1rem; 
            padding: 1rem; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); 
            /* ë‚´ë¶€ ì½˜í…ì¸ (ìº”ë²„ìŠ¤)ê°€ ë¶€ëª¨ í¬ê¸°ì— ë§ë„ë¡ flex ì„¤ì • */
            display: flex; 
            flex-direction: column; 
            /* í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€ CSSëŠ” ìœ ì§€ */
            user-select: none; 
            -webkit-user-select: none; 
            -moz-user-select: none; 
            -ms-user-select: none; 
            touch-action: none; /* í„°ì¹˜ ì´ë²¤íŠ¸ ì¶©ëŒ ë°©ì§€ */
        }
        /* ë¡œë”© ì¸ë””ì¼€ì´í„° */
        #loadingIndicator {
            display: none; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ */
            position: absolute;
            inset: 0;
            background-color: rgba(255, 255, 255, 0.9);
            z-index: 10;
            border-radius: 1rem;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#10b981', /* ì—ë©”ë„ë“œ ê·¸ë¦° ê³„ì—´ */
                        'primary-dark': '#0f766e',
                    }
                }
            }
        }
    </script>
</head>
<body class="p-4 md:p-8">

    <div id="chartContainer" class="space-y-6">
        <h1 class="text-3xl font-bold text-gray-800 text-center">
            ê·¼ìŠ¤í”¼
        </h1>

        <!-- ì°¨íŠ¸ ì»¨íŠ¸ë¡¤ -->
        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
             <div class="flex flex-col sm:flex-row justify-center">
                <button onclick="resetZoom()" id="resetButton" class="w-full sm:w-1/2 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 ease-in-out shadow-md hover:shadow-lg">
                    ğŸ”„ ì°¨íŠ¸ ì´ˆê¸°í™” (Zoom/Pan ë¦¬ì…‹)
                </button>
            </div>
            <p id="statusMessage" class="mt-4 text-sm text-red-500 font-medium hidden text-center"></p>
        </div>

        <!-- ì°¨íŠ¸ ìº”ë²„ìŠ¤ (ë†’ì´ ì¡°ì •ë¨) -->
        <div class="chart-canvas h-[500px] max-h-[70vh] relative">
            <div id="loadingIndicator" class="flex items-center justify-center text-lg font-medium text-gray-700">
                CSV ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
            </div>
            
            <canvas id="timeSeriesChart" class="flex-1"></canvas>
        </div>

        <p class="text-sm text-gray-500 mt-4 text-center" id="lastUpdated">
            ë°ì´í„° ë¡œë“œ ëŒ€ê¸° ì¤‘...
        </p>
    </div>

    <script>
        let myChart; // Chart.js ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì €ì¥í•  ì „ì—­ ë³€ìˆ˜
        const CSV_URL = 'data.csv'; // GitHub Pagesì—ì„œ ì½ì–´ì˜¬ íŒŒì¼ëª…
        const UPDATE_INTERVAL_MS = 5 * 60 * 1000; // 5ë¶„
        const TWELVE_HOURS_IN_MS = 12 * 60 * 60 * 1000; // 12ì‹œê°„ì„ ë°€ë¦¬ì´ˆë¡œ ì •ì˜
        
        /**
         * CSV í…ìŠ¤íŠ¸ë¥¼ Chart.js ë°ì´í„° í˜•ì‹ìœ¼ë¡œ íŒŒì‹±í•©ë‹ˆë‹¤.
         */
        function parseCsvData(csvText) {
            const rows = csvText.trim().split('\n');
            if (rows.length < 2) return [];

            const header = rows[0].split(',').map(h => h.trim().toLowerCase());
            const data = [];
            
            // í—¤ë”ì—ì„œ timestampì™€ value ì¸ë±ìŠ¤ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
            const timeIndex = header.indexOf('timestamp');
            const valueIndex = header.indexOf('value');

            if (timeIndex === -1 || valueIndex === -1) {
                throw new Error("CSV í—¤ë”ì— 'timestamp' ë˜ëŠ” 'value'ê°€ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.");
            }

            for (let i = 1; i < rows.length; i++) {
                const cols = rows[i].split(',').map(c => c.trim());
                
                if (cols.length > Math.max(timeIndex, valueIndex)) {
                    const timestamp = new Date(cols[timeIndex]);
                    const value = parseFloat(cols[valueIndex]);

                    // ìœ íš¨í•œ ë°ì´í„°ë§Œ ì¶”ê°€
                    if (!isNaN(timestamp.getTime()) && !isNaN(value)) {
                        data.push({ x: timestamp.getTime(), y: value });
                    }
                }
            }
            
            // ë°ì´í„°ë¥¼ ì‹œê°„ ìˆœìœ¼ë¡œ ì •ë ¬í•©ë‹ˆë‹¤. (Chart.js time scale ìš”êµ¬ì‚¬í•­)
            data.sort((a, b) => a.x - b.x);
            return data;
        }
        
        /**
         * GitHub Pagesì˜ data.csv íŒŒì¼ì„ ë¹„ë™ê¸°ì ìœ¼ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.
         */
        async function fetchData() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const lastUpdatedElement = document.getElementById('lastUpdated');
            const statusMessage = document.getElementById('statusMessage');

            loadingIndicator.style.display = 'flex';
            statusMessage.classList.add('hidden');
            lastUpdatedElement.textContent = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';

            try {
                // ìºì‹œ ë¬¸ì œ í•´ê²°ì„ ìœ„í•´ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ì— í˜„ì¬ ì‹œê°„ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
                const urlWithCacheBuster = `${CSV_URL}?v=${Date.now()}`;
                
                const response = await fetch(urlWithCacheBuster, { cache: "no-store" });
                
                if (!response.ok) {
                    throw new Error(`HTTP ì˜¤ë¥˜: ${response.status} (${response.statusText}). GitHubì— ${CSV_URL} íŒŒì¼ì´ ì˜¬ë°”ë¥´ê²Œ ì»¤ë°‹ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.`);
                }
                
                const csvText = await response.text();
                const dataPoints = parseCsvData(csvText);
                
                if (dataPoints.length === 0) {
                     throw new Error("CSV íŒŒì¼ì„ ì½ì—ˆìœ¼ë‚˜ ìœ íš¨í•œ ë°ì´í„° í¬ì¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. í—¤ë”ì™€ ë°ì´í„° í˜•ì‹ì„ í™•ì¸í•˜ì„¸ìš”.");
                }

                updateChart(dataPoints);
                
                lastUpdatedElement.textContent = `âœ… ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${new Date().toLocaleTimeString('ko-KR')}`;
                
            } catch (error) {
                console.error("ë°ì´í„° ë¡œë“œ ë° íŒŒì‹± ì‹¤íŒ¨:", error);
                statusMessage.textContent = `ğŸš¨ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜: ${error.message}`;
                statusMessage.classList.remove('hidden');
                lastUpdatedElement.textContent = 'âŒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨';
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }

        /**
         * Yì¶• ìŠ¤ì¼€ì¼ì„ í˜„ì¬ ë³´ì´ëŠ” ë°ì´í„° ë²”ìœ„ì— ë§ê²Œ ì¡°ì •í•©ë‹ˆë‹¤.
         */
        const autoAdjustYScale = ({ chart }) => {
            const xScale = chart.scales.x;
            const dataPoints = chart.data.datasets[0].data; 
            
            const xMin = xScale.min;
            const xMax = xScale.max;
            
            let yValues = [];
            
            for (const point of dataPoints) {
                // point.xëŠ” íƒ€ì„ìŠ¤íƒ¬í”„ (ìˆ«ì)
                if (point.x >= xMin && point.x <= xMax) {
                    yValues.push(point.y);
                }
            }
            
            if (yValues.length > 0) {
                const minY = Math.min(...yValues);
                const maxY = Math.max(...yValues);

                const padding = (maxY - minY) * 0.05;
                const newMinY = minY - padding;
                const newMaxY = maxY + padding;

                const yScale = chart.scales.y;
                
                yScale.min = newMinY < 0 ? 0 : newMinY;
                yScale.max = newMaxY;
                
                chart.update('none'); 
            } else {
                 chart.scales.y.min = undefined;
                 chart.scales.y.max = undefined;
                 chart.update('none');
            }
        };

        /**
         * ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•˜ê±°ë‚˜ ê¸°ì¡´ ì¸ìŠ¤í„´ìŠ¤ì˜ ë°ì´í„°ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         */
        function updateChart(dataPoints) {
            const ctx = document.getElementById('timeSeriesChart').getContext('2d');
            
            const data = {
                datasets: [{
                    label: 'ì‹œê³„ì—´ ê°’ (Value)',
                    data: dataPoints,
                    borderColor: 'rgb(16, 185, 129)', 
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    borderWidth: 2,
                    pointRadius: 1, 
                    pointHoverRadius: 5,
                    tension: 0.1, 
                    fill: false
                }]
            };

            const config = {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false, 
                    animation: false, 
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                tooltipFormat: 'yyyy-MM-dd HH:mm:ss'
                            },
                            title: { display: true, text: 'ì‹œê°„ (Timestamp)', color: '#4b5563' },
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        },
                        y: {
                            beginAtZero: false,
                            title: { display: true, text: 'ê°’ (Value)', color: '#4b5563' },
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        }
                    },
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: { mode: 'index', intersect: false },
                        zoom: {
                            zoom: {
                                enabled: true, 
                                wheel: { enabled: true, modifierKey: null }, // Shift í‚¤ ì—†ì´ íœ  ì¤Œ
                                pinch: { enabled: true },
                                mode: 'x', 
                                speed: 0.1,
                                duration: 0, 
                                onZoomComplete: autoAdjustYScale, 
                            },
                            pan: {
                                enabled: true,
                                mode: 'x', 
                                threshold: 5,
                                modifierKey: null, // Shift í‚¤ ì—†ì´ ë“œë˜ê·¸ Pan
                                onPanComplete: autoAdjustYScale, 
                            },
                            limits: { x: { min: 'original', max: 'original' } } 
                        }
                    }
                }
            };

            // --- [ìƒˆë¡œìš´ ê¸°ëŠ¥] ì´ˆê¸° 12ì‹œê°„ ë·° ì„¤ì • ---
            if (dataPoints.length > 0) {
                const latestTime = dataPoints[dataPoints.length - 1].x; // ê°€ì¥ ìµœì‹  íƒ€ì„ìŠ¤íƒ¬í”„ (ë°€ë¦¬ì´ˆ)
                const startTime = latestTime - TWELVE_HOURS_IN_MS; // 12ì‹œê°„ ì „ ì‹œê°„ ê³„ì‚°

                // Xì¶• ì´ˆê¸° ë²”ìœ„ ì„¤ì •
                config.options.scales.x.min = startTime;
                config.options.scales.x.max = latestTime;
            }
            // --- [ìƒˆë¡œìš´ ê¸°ëŠ¥] ë ---

            if (myChart) {
                // ê¸°ì¡´ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
                myChart.data.datasets[0].data = dataPoints;
                // ê¸°ì¡´ ì°¨íŠ¸ì˜ ì˜µì…˜ì—ë„ 12ì‹œê°„ ë²”ìœ„ ì ìš© (ì—…ë°ì´íŠ¸ ì‹œ ë¦¬ì…‹ë˜ì§€ ì•Šë„ë¡)
                myChart.options.scales.x.min = config.options.scales.x.min;
                myChart.options.scales.x.max = config.options.scales.x.max;
                
                myChart.update();
                autoAdjustYScale({ chart: myChart });
            } else {
                // ìƒˆ ì°¨íŠ¸ ìƒì„±
                myChart = new Chart(ctx, config);
                autoAdjustYScale({ chart: myChart });
            }
            document.getElementById('resetButton').disabled = false;
        }

        /**
         * ì¤Œ ë° íŒ¬ ìƒíƒœë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
         */
        function resetZoom() {
            if (myChart && myChart.resetZoom) {
                // resetZoom()ì€ Xì¶•ì„ ì „ì²´ ë°ì´í„° ë²”ìœ„ë¡œ ë˜ëŒë¦½ë‹ˆë‹¤.
                myChart.resetZoom();
                
                // ì¤Œ ë¦¬ì…‹ í›„ Yì¶•ë„ ì´ˆê¸° ì „ì²´ ë°ì´í„° ë²”ìœ„ë¡œ ì¬ì¡°ì •
                myChart.scales.y.min = undefined;
                myChart.scales.y.max = undefined;
                myChart.update('none');
            }
        }

        // ì´ˆê¸° ë¡œë“œ ì‹œ ì°¨íŠ¸ ë Œë”ë§ ë° 5ë¶„ë§ˆë‹¤ ì—…ë°ì´íŠ¸ ì„¤ì •.
        window.onload = () => {
             fetchData();
             // 5ë¶„ë§ˆë‹¤ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
             setInterval(fetchData, UPDATE_INTERVAL_MS);
        };

    </script>
</body>
</html>
